<html>
    <head>
        <title>Create Account</title>
        <link rel='stylesheet' href="./css/style.css" />
        <link rel='stylesheet' href="./css/animate.css" />
        <script src="https://code.jquery.com/jquery-3.2.1.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.5.2/firebase.js"></script>
        <script src="./js/fireprescript.js"></script>
        <script>
            function submitAccount() {
                try {
                    var username = $("input[type=text][name=Username").val();

                    var _state = $("select[name=State]").val();
                    var _city = $("input[type=text][name=City]").val();
                    var _school = $("input[type=text][name=School]").val();

                    var locale = {
                        state: _state,
                        city: _city,
                        school: _school
                    };

                    // Write new user to firebase
                    database.ref('users/' + username).set(locale);

                    // Now sign them in
                    sessionStorage.setItem('state', _state);
                    sessionStorage.setItem('city', _city);
                    sessionStorage.setItem('school', _school);

                    // Redirect to events page
                    return true;
                } catch (e) {
                    console.log(e);
                    return false;
                }
            }
        </script>
    </head>

    <body>
        <div style="width:100%;height:100%;display:table;">
            <div id='noflex'>
                <h1 id='intro' class="animated fadeInDown">Create Account</h1><br/>
                <form action="viewevents.html" method='get' onsubmit="return submitAccount();" style="text-align:left;color:teal;display:inline-block;">
                    Username:<br/><input type='text' name='Username'/><br/>
                    <span style="font-weight:bold;" id="availability"></span><br/>
                    State:<br/><select name='State'>
                        <option value="AL">Alabama</option>
                        <option value="AK">Alaska</option>
                        <option value="AZ">Arizona</option>
                        <option value="AR">Arkansas</option>
                        <option value="CA">California</option>
                        <option value="CO">Colorado</option>
                        <option value="CT">Connecticut</option>
                        <option value="DE">Delaware</option>
                        <option value="DC">District Of Columbia</option>
                        <option value="FL">Florida</option>
                        <option value="GA">Georgia</option>
                        <option value="HI">Hawaii</option>
                        <option value="ID">Idaho</option>
                        <option value="IL">Illinois</option>
                        <option value="IN">Indiana</option>
                        <option value="IA">Iowa</option>
                        <option value="KS">Kansas</option>
                        <option value="KY">Kentucky</option>
                        <option value="LA">Louisiana</option>
                        <option value="ME">Maine</option>
                        <option value="MD">Maryland</option>
                        <option value="MA">Massachusetts</option>
                        <option value="MI">Michigan</option>
                        <option value="MN">Minnesota</option>
                        <option value="MS">Mississippi</option>
                        <option value="MO">Missouri</option>
                        <option value="MT">Montana</option>
                        <option value="NE">Nebraska</option>
                        <option value="NV">Nevada</option>
                        <option value="NH">New Hampshire</option>
                        <option value="NJ">New Jersey</option>
                        <option value="NM">New Mexico</option>
                        <option value="NY">New York</option>
                        <option value="NC">North Carolina</option>
                        <option value="ND">North Dakota</option>
                        <option value="OH">Ohio</option>
                        <option value="OK">Oklahoma</option>
                        <option value="OR">Oregon</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="RI">Rhode Island</option>
                        <option value="SC">South Carolina</option>
                        <option value="SD">South Dakota</option>
                        <option value="TN">Tennessee</option>
                        <option value="TX">Texas</option>
                        <option value="UT">Utah</option>
                        <option value="VT">Vermont</option>
                        <option value="VA">Virginia</option>
                        <option value="WA">Washington</option>
                        <option value="WV">West Virginia</option>
                        <option value="WI">Wisconsin</option>
                        <option value="WY">Wyoming</option>
                    </select><br/><br/>
                    City:<br/><input type='text' name='City' /><br/><br/>
                    School:<br/><input type='text' name='School' /><br/><br/>
                    <input type='submit' value="Create Account" name='Submit' />
                </form>
            </div>
        </div>
        <script>
            // Make everything same width as header
            var w = $('#intro').css('width');
            $('input').css('width', w);
            $('select').css('width', w);

            // Can't submit form till username is validated
            $('input[type=submit]').attr('disabled', true);
            $('input[type=submit]').hide();

            // Validate username
            $("input[type=text][name=Username]").focusout(function() {
                var _username = $(this).val();
                database.ref('users/' + _username).once('value', function(snap) {
                    if (snap.val() != null || _username.length < 5) {
                        // User already exists or invalid name
                        $('#availability').css('color', 'red');
                        $('#availability').text('Not Available');
                        $('input[type=submit]').attr('disabled', true);
                        $('input[type=submit]').hide();
                    } else {
                        // Username available
                        $('#availability').css('color', 'green');
                        $('#availability').text('Available');
                        $('input[type=submit]').removeAttr('disabled');
                        $('input[type=submit]').show();
                    }
                });
            });

            // Don't want them entering a valid username and then changing it :)
            $("input[type=text][name=Username]").focus(function() {
                $('input[type=submit]').attr('disabled', true)
                $('input[type=submit]').hide();
            });
        </script>
    </body>
</html>